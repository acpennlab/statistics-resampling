% Check if running in Octave (else assume Matlab)
info = ver; 
isoctave = any (ismember ({info.Name}, 'Octave'));

% Create cell array of paths to add
arch = computer('arch');
[comp, maxsize, endian] = computer ();
binary = true;
switch endian
  case 'L' 
    if isoctave
      arch_idx = regexpi (arch, {'mingw32-i686', 'mingw32-x86_64', '^darwin.*x86_64$', 'gnu-linux-x86_64'});
      binary_paths = {'..\bin\octave\win\win32','..\bin\octave\win\win64','../bin/octave/mac/maci64', '../bin/octave/linux/glnxa64'};
    else
      arch_idx = regexpi (arch, {'win32', 'win64', 'maci64', 'glnxa64'});
      binary_paths = {'..\bin\matlab\win\win32','..\bin\matlab\win\win64','../bin/matlab/mac/maci64', '../bin/matlab/linux/glnxa64'};
    end
    dirlist = {'helper', 'param', 'legacy', sprintf('legacy%shelper', filesep), sprintf('..%sbin', filesep), binary_paths{~cellfun(@isempty,arch_idx)}};
    if (numel(dirlist) < 6)
      binary = false;
    end
  case 'B'
    binary = false;
end
dirname = fileparts (mfilename ('fullpath'));

% Attemt to compile binaries from source code automatically if no suitable binaries can be found
if ~binary
  disp('No precombined binaries available for your platform. Attempting to compile from source code...')
  if isoctave
    try
      mkoctfile --mex --output ./bin/boot ./src/boot.cpp
    catch
      err = lasterror();
      disp(err.message);
      warning ('Could not compile boot.%s. Falling back to the (slower) boot.m file.',mexext)
    end
    path_to_smoothmedian = sprintf ('./inst/param/smoothmedian.%s',mexext);
    try
      mkoctfile --mex --output ./bin/smoothmedian ./src/smoothmedian.cpp
    catch
      err = lasterror();
      disp(err.message);
      warning ('Could not compile smoothmedian.%s. Falling back to the (slower) smoothmedian.m file.',mexext)
    end
  else
    try  
      mex -setup c++
    catch
      err = lasterror();
      disp(err.message);
    end
    try
      mex -compatibleArrayDims -output ./bin/boot ./src/boot.cpp
    catch
      err = lasterror();
      disp(err.message);
      warning ('Could not compile boot.%s. Falling back to the (slower) boot.m file.',mexext)
    end
    try
      mex -compatibleArrayDims -output ./bin/smoothmedian ./src/smoothmedian.cpp
    catch
      err = lasterror();
      disp(err.message);
      warning ('Could not compile smoothmedian.%s. Falling back to the (slower) smoothmedian.m file.',mexext)
    end
  end
end


% Add paths
if ~exist (fullfile (dirname, 'inst'), 'dir')
  %% Run this if the package is installed
  for ii=1:length (dirlist)
     addpath (fullfile (dirname, dirlist{ii}), '-end')
  end
else
  %% Run this if we are testing the package without installation
  addpath (fullfile (dirname, 'inst'))
  for ii=1:length(dirlist)
    addpath (fullfile (dirname, 'inst', dirlist{ii}))
  end
end

clear arch comp maxsize endian binary arch_idx binary_paths dirlist dirname 
